{% extends 'base.html' %}

{% block titulo %}
Formulario Presupuesto Proveedor
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3>Formulario Presupuesto de Proveedor</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Columna izquierda -->
                <div class="col-md-6 d-flex flex-column">
                  <!-- Combo empleados -->
                  <div class="form-group">
                    <label for="cbo_empleado">Empleados:</label>
                    <select id="cbo_empleado" class="custom-select">
                      <option selected>Empleados</option>
                      {% for item in empleados %}
                      <option value="{{ item['id_empleado'] }}">
                        {{ item['empleado'] }} - CI: {{ item['ci'] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
              
                  <!-- Combo sucursales -->
                  <div class="form-group">
                    <label for="cbo_sucursal">Sucursales:</label>
                    <select id="cbo_sucursal" class="custom-select">
                      <option value="">Sucursales</option>
                      {% for item in sucursales %}
                      <option value="{{ item['id'] }}">
                        {{ item['descripcion'] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- Fecha de Pedido -->
                  <div class="form-group">
                    <label for="txt_fecha_de_pedido">Fecha de Pedido:</label>
                    <input type="date" class="form-control" id="txt_fecha_de_pedido" />
                  </div>
                </div>
              
                <!-- Columna derecha -->
                <div class="col-md-6 d-flex flex-column">
                  <!-- Combo pedido -->
                  <div class="form-group">
                    <label for="cbo_pedido">Pedido por fecha:</label>
                    <select id="cbo_pedido" class="custom-select">
                      <option value="">Seleccione un pedido</option>
                      {% for pedido in pedidos %}
                      <option value="{{ pedido['id_pedido_compra'] }}">
                          Fecha: {{ pedido['fecha_pedido'] }}
                      </option>
                      {% endfor %}
                  </select>
                </div>
              
                  <!-- Combo proveedor -->
                  <div class="form-group">
                    <label for="cbo_proveedor">Proveedores</label>
                    <select id="cbo_proveedor" class="custom-select">
                      <option value="">Proveedores</option>
                      {% for item in proveedores %}
                      <option value="{{ item['id_proveedor'] }}">
                      Ruc  {{ item['ruc'] }} - R Social: {{ item['razon_social'] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>

            <!-- Combo producto -->
             
            <!-- <div class="form-group row mt-3">
              <label for="cbo_producto" class="col-md-2 col-form-label">Producto:</label>
              <div class="col-md-6">
                  <select id="cbo_producto" class="custom-select">
                    <option value="">Productos</option>
                      {% for item in productos %}
                        <option value="{{ item['id_producto'] }}">
                          {{ item['nombre'] }}
                        </option>
                      {% endfor %}
                  </select>
              </div>
              <div class="col col-md-4">
                <button type="button" class="btn btn-primary" id="btn_agregar_producto">Agregar</button>
              </div>
            </div>
            

             "Cantidad de producto" 
            <div class="form-group row mt-3">
              <label for="txt_cantidad" class="col-md-2 col-form-label">Cantidad:</label>
              <div class="col-md-2">
                <input type="number" class="form-control mb-2 mr-md-2" placeholder="Cantidad" id="txt_cantidad" min="0">
              </div>
            </div> -->
            
            <!--  -->

            <hr>
            <div class="row">
                <div class="col col-md-12">
                  <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>descripción</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody id="productos-table-body">
                        
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button type="button" class="btn btn-primary" id="btn_registrar_pedido">Registrar Presupuesto</button>
            <button type="button" class="btn btn-warning" id="btn_salir_operacion">Salir de la operación</button>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
  document.getElementById('cbo_pedido').addEventListener('change', function() {
    const pedidoId = this.value;

    if (pedidoId) {
        // Hacer la solicitud a la API para obtener el detalle del pedido
        fetch(`/api/v1/gestionar-compras/registrar-pedido-compras/detalle-pedido/${pedidoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tableBody = document.getElementById('productos-table-body');
                    tableBody.innerHTML = ''; // Limpiar la tabla antes de agregar los nuevos productos

                    // Llenar la tabla con los productos del pedido
                    data.data.forEach(producto => {
                        const row = `
                            <tr>
                                <td>${producto.id_producto}</td>
                                <td>${producto.nombre}</td>
                                <td>${producto.cantidad}</td>
                                <td>
                                <input type="number" min="0" placeholder="Precio">
                            </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                } else {
                    alert('No se encontraron detalles para este pedido.');
                }
            })
            .catch(error => {
                console.error('Error al cargar productos:', error);
                alert('Ocurrió un error al cargar los detalles del pedido.');
            });
    } else {
        // Limpiar la tabla si no hay un pedido seleccionado
        const tableBody = document.getElementById('productos-table-body');
        tableBody.innerHTML = '';
    }
});
</script>
{% endblock %}