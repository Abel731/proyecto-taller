{% extends 'base.html' %}

{% block titulo %}
Formulario Presupuesto Proveedor
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3>Formulario Presupuesto de Proveedor</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Columna izquierda -->
                <div class="col-md-6 d-flex flex-column">
                  <!-- Combo empleados -->
                  <div class="form-group">
                    <label for="cbo_empleado">Empleados:</label>
                    <select id="cbo_empleado" class="custom-select">
                      <option selected>Empleados</option>
                      {% for item in empleados %}
                      <option value="{{ item['id_empleado'] }}">
                        {{ item['empleado'] }} - CI: {{ item['ci'] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
              
                  <!-- Combo sucursales -->
                  <div class="form-group">
                    <label for="cbo_sucursal">Sucursales:</label>
                    <select id="cbo_sucursal" class="custom-select">
                      <option value="">Sucursales</option>
                      {% for item in sucursales %}
                      <option value="{{ item['id'] }}">
                        {{ item['descripcion'] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                  
                  <!-- Fecha de Pedido -->
                  <div class="form-group">
                    <label for="txt_fecha_de_pedido">Fecha de Pedido:</label>
                    <input type="date" class="form-control" id="txt_fecha_de_pedido" />
                  </div>
                </div>
              
                <!-- Columna derecha -->
                <div class="col-md-6 d-flex flex-column">
                  <!-- Combo pedido -->
                  <div class="form-group">
                    <label for="cbo_pedido">Pedido por fecha:</label>
                    <select id="cbo_pedido" class="custom-select">
                      <option value="">Seleccione un pedido</option>
                      {% for pedido in pedidos %}
                      <option value="{{ pedido['id_pedido_compra'] }}">
                          Fecha: {{ pedido['fecha_pedido'] }}
                      </option>
                      {% endfor %}
                  </select>
                </div>
              
                  <!-- Combo proveedor -->
                  <div class="form-group">
                    <label for="cbo_proveedor">Proveedores</label>
                    <select id="cbo_proveedor" class="custom-select">
                      <option value="">Proveedores</option>
                      {% for item in proveedores %}
                      <option value="{{ item['id_proveedor'] }}">
                      Ruc  {{ item['ruc'] }} - R Social: {{ item['razon_social'] }}
                      </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>

            <hr>
            <div class="row">
                <div class="col col-md-12">
                  <table class="table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>descripción</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                        </tr>
                    </thead>
                    <tbody id="productos-table-body">
                        
                    </tbody>
                </table>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <button type="button" class="btn btn-primary" id="btn_registrar_pedido">Registrar Presupuesto</button>
            <button type="button" class="btn btn-warning" id="btn_salir_operacion">Salir de la operación</button>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
  document.getElementById('cbo_pedido').addEventListener('change', function () {
    const pedidoId = this.value;

    if (pedidoId) {
      // Solicitar el detalle del pedido a la API
      fetch(`/api/v1/gestionar-compras/registrar-pedido-compras/detalle-pedido/${pedidoId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error en la respuesta: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const tableBody = document.getElementById('productos-table-body');
            tableBody.innerHTML = ''; // Limpiar tabla antes de agregar nuevos productos

            data.data.forEach(producto => {
              const row = `
                <tr data-id="${producto.id_producto}">
                  <td>${producto.id_producto}</td>
                  <td>${producto.nombre}</td>
                  <td>${producto.cantidad}</td>
                  <td>
                    <input type="number" class="form-control precio-producto" placeholder="Precio" min="0">
                  </td>
                </tr>`;
              tableBody.innerHTML += row;
            });
          } else {
            alert('No se encontraron detalles para este pedido.');
          }
        })
        .catch(error => {
          console.error('Error al cargar productos:', error);
          alert('Ocurrió un error al cargar los detalles del pedido.');
        });
    } else {
      // Limpiar la tabla si no se seleccionó un pedido
      document.getElementById('productos-table-body').innerHTML = '';
    }
  });

  document.getElementById('btn_registrar_pedido').addEventListener('click', function () {
    const productos = [];
    const rows = document.querySelectorAll('#productos-table-body tr');

    rows.forEach(row => {
      const idProducto = Number(row.dataset.id);
      const precio = row.querySelector('.precio-producto').value;

      if (precio) {
        productos.push({
          id_producto: idProducto,
          precio_unitario: Number(precio),
        });
      }
    });

    const payload = {
      id_empleado: Number(document.getElementById('cbo_empleado').value),
      id_sucursal: Number(document.getElementById('cbo_sucursal').value),
      fecha_presupuesto: document.getElementById('txt_fecha_de_pedido').value,
      id_proveedor: Number(document.getElementById('cbo_proveedor').value),
      productos: productos,
    };

    console.log('Payload enviado:', payload);

    // Enviar el presupuesto a la API
    console.log(payload);
    fetch(`/api/v1/gestionar-compras/registrar-presupuesto-proveedor`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Error en la respuesta: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          alert('Presupuesto registrado correctamente.');
          location.replace("{{ url_for('pdpmod.presupuestos_index') }}");
        } else {
          alert(data.error || 'Error al registrar el presupuesto.');
        }
      })
      .catch(error => {
        console.error('Error al registrar presupuesto:', error);
        alert('Ocurrió un error al registrar el presupuesto.');
      });
  });

  document.getElementById('btn_salir_operacion').addEventListener('click', function () {
    location.replace("{{ url_for('pdpmod.presupuestos_index') }}");
  });
</script>
{% endblock %}